<html>
  <head>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-physics-system@v4.1.2/dist/aframe-physics-system.min.js"></script>
    <script src="https://cdn.rawgit.com/wmurphyrd/aframe-super-hands-component/master/dist/aframe-super-hands-component.min.js"></script>
  </head>
  <body>
    <script>
      AFRAME.registerComponent("click-grab", {
        init: function () {
          let el = this.el;
          let scene = el.sceneEl;
          let camera = document.querySelector("a-camera");
          let isGrabbed = false;

          function updatePosition(event) {
            if (isGrabbed) {
              let cameraPos = new THREE.Vector3();
              let cameraQuat = new THREE.Quaternion();
              
              camera.object3D.getWorldPosition(cameraPos);
              camera.object3D.getWorldQuaternion(cameraQuat);
              
              // Convertit la position de la souris en coordonnées 3D
              let mouseX = (event.clientX / window.innerWidth) * 2 - 1;
              let mouseY = -(event.clientY / window.innerHeight) * 2 + 1;

              let offset = new THREE.Vector3(mouseX * 0.5, mouseY * 0.5, -1); // Toujours devant
              offset.applyQuaternion(cameraQuat); // Oriente l'objet devant la caméra

              let newPosition = cameraPos.clone().add(offset);
              el.object3D.position.copy(newPosition);
            }
          }

          el.addEventListener("mousedown", function () {
            console.log("Objet attrapé !");
            isGrabbed = true;
            el.setAttribute("dynamic-body", "mass: 0"); // Désactive la gravité
            window.addEventListener("mousemove", updatePosition);
          });

          scene.addEventListener("mouseup", function () {
            if (isGrabbed) {
              console.log("Objet tombé !");
              el.setAttribute("dynamic-body", "mass: 1; restitution: 0.6; friction: 0.5"); // Réactive la gravité
              isGrabbed = false;
              window.removeEventListener("mousemove", updatePosition);
            }
          });
        },
      });
    </script>

    <a-scene physics="gravity: -9.8">
      <!-- Sol avec collision réaliste -->
      <a-plane position="0 0 0" rotation="-90 0 0" width="10" height="10" color="green"
               static-body material="shader: standard; roughness: 1; metalness: 0"></a-plane>

      <!-- Objet à attraper avec physique avancée -->
      <a-box id="grabbableBox" position="0 1 -3" width="0.5" height="0.5" depth="0.5" color="red"
             class="grabbable clickable"
             dynamic-body="shape: box; mass: 1; restitution: 0.6; friction: 0.5"
             grabbable
             click-grab></a-box>

      <a-entity cursor="rayOrigin: mouse" raycaster="objects: .clickable"></a-entity>

      <!-- Caméra et contrôleurs -->
      <a-entity id="cameraRig" position="0 1.6 0">
        <a-camera position="0 0 0" wasd-controls look-controls></a-camera>
      </a-entity>
    </a-scene>
  </body>
</html>
